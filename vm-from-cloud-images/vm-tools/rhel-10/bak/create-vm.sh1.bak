#!/bin/bash

# Configuration
VM_NAME=$1
BASE_IMG="$HOME/vm-tools/AlmaLinux-10.qcow2"
POOL_DIR="/var/lib/libvirt/images"
TMP_DATA="/tmp/user-data-$VM_NAME"

if [ -z "$VM_NAME" ]; then
    echo "Usage: ./create-vm.sh <vm-name>"
    exit 1
fi

# Ensure permissions
chmod +x $HOME $HOME/vm-tools 2>/dev/null

echo "üöÄ Deploying UEFI AlmaLinux 10 VM: $VM_NAME..."

# 1. Create the Cloud-init config
cat <<EOF > "$TMP_DATA"
#cloud-config
hostname: $VM_NAME
fqdn: $VM_NAME.local
ssh_pwauth: true

# Official update module
package_update: true
package_upgrade: true

users:
  - name: raj
    groups: wheel
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: "xxxxxxxxxxxxx"
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAGbAwADv9elOFsGLEXIhitUJrSaHyiPl5byE75+SSMN Test-Computer

# System-wide Aliases (Most reliable for RHEL/Alma 10)
write_files:
  - path: /etc/profile.d/raj_aliases.sh
    owner: root:root
    permissions: '0644'
    content: |
      alias c='clear'
      alias cls='clear'

growpart:
  mode: auto
  devices: ['/']

runcmd:
  - hostnamectl set-hostname $VM_NAME
  - restorecon -v /etc/profile.d/raj_aliases.sh
EOF

# 2. Create Clone
sudo qemu-img create -f qcow2 -b "$BASE_IMG" -F qcow2 "$POOL_DIR/$VM_NAME.qcow2" 25G

# 3. Launch VM
sudo virt-install \
  --name "$VM_NAME" \
  --memory 1583 \
  --vcpus 1 \
  --os-variant almalinux10 \
  --boot uefi \
  --machine q35 \
  --disk path="$POOL_DIR/$VM_NAME.qcow2",format=qcow2 \
  --import \
  --network network=Private-Network \
  --cloud-init user-data="$TMP_DATA" \
  --graphics none \
  --noautoconsole

rm "$TMP_DATA"

echo "‚è≥ Waiting for VM to obtain an IP..."

# Improved Wait Loop
while true; do
    IP=$(sudo virsh domifaddr "$VM_NAME" | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n 1)
    if [ ! -z "$IP" ]; then
        echo -e "\n‚úÖ VM $VM_NAME is Ready!"
        echo "IP Address: $IP"
        echo "SSH Command: ssh raj@$IP"
        break
    fi
    printf "."
    sleep 3
done
